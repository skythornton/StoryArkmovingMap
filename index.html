<!DOCTYPE html>
<html>
<head>
    <title>Story Ark Moving Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <style>
        body { margin:0; padding:0; }
        #map { width: 100%; height: 100vh; }

        /* Timeline styles */
        #timeline-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 30px;
            background-color: #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: sans-serif;
            font-size: 14px;
            color: #333;
            z-index: 1000
        
        }

        #timeline-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 5px;
            background-color: #4caf50; /* green progress bar */
            width: 0%;
            transition: width 0.05s linear;
            z-index: 1001
        }

        #timeline-label {
            z-index: 1002;
            background: rgba(255,255,255,0.8);
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
        }
        
    </style>
</head>
<body>

<div id="map"></div>

<div id="timeline-container">
    <div id="timeline-progress"></div>
    <div id="timeline-label">Start Date</div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
    // Initialize the map centered on South Africa
    const map = L.map('map').setView([-29.5, 24], 6);

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // Car icon
    const carIcon = L.icon({
        iconUrl: 'storyark_car.png',  // <-- your custom image
        iconSize: [70, 30],           // <-- adjust size as needed
        iconAnchor: [35, 15]          // <-- adjust anchor to center bottom
    });

    // Marker (starts hidden)
    const marker = L.marker([0, 0], {icon: carIcon, opacity: 0}).addTo(map);

    //timeline
    const startDate = new Date('2024-10-06'); // Change to your start date
    const endDate = new Date('2025-06-19');   // Change to your end date
    const totalTime = endDate - startDate;    // Total duration in ms


    // Fetch the GeoJSON route
    fetch('StoryArk_journey.json')
        .then(response => {
            if (!response.ok) throw new Error('Failed to load StoryArk_journey.geojson');
            return response.json();
        })
        .then(data => {
            const routeCoords = [];

            data.features.forEach(feature => {
                const geom = feature.geometry;

                if (geom.type === 'LineString') {
                    geom.coordinates.forEach(coord => {
                        routeCoords.push([coord[1], coord[0]]); // [lat, lon]
                    });
                }

                if (geom.type === 'MultiLineString') {
                    geom.coordinates.forEach(line => {
                        line.forEach(coord => {
                            routeCoords.push([coord[1], coord[0]]);
                        });
                    });
                }
            });

            if (routeCoords.length === 0) {
                throw new Error('No route coordinates found in GeoJSON');
            }

            // Draw the route line
            const routeLine = L.polyline(routeCoords, {color: 'red', weight: 4}).addTo(map);
            map.fitBounds(routeLine.getBounds());

            // Initialize marker at start
            marker.setLatLng(routeCoords[0]);
            marker.setOpacity(1);

            // Start smooth animation
            animateSmooth(routeCoords);
        })
        .catch(err => console.error('Error loading GeoJSON:', err));

    // Smooth animation function
    function animateSmooth(routeCoords) {
        let totalDistance = 0;
        const distances = [0];

        // Calculate cumulative distance between points
        for (let i = 1; i < routeCoords.length; i++) {
            const from = L.latLng(routeCoords[i - 1]);
            const to = L.latLng(routeCoords[i]);
            totalDistance += from.distanceTo(to);
            distances.push(totalDistance);
        }

        let progress = 0; // Progress along the route in meters
        const stepSize = 120; // Distance per frame in meters
        const animationSpeed = 0.5; // Delay between frames in ms

        function interpolatePosition(progress) {
            for (let i = 1; i < distances.length; i++) {
                if (progress <= distances[i]) {
                    const ratio = (progress - distances[i - 1]) / (distances[i] - distances[i - 1]);
                    const lat = routeCoords[i - 1][0] + (routeCoords[i][0] - routeCoords[i - 1][0]) * ratio;
                    const lng = routeCoords[i - 1][1] + (routeCoords[i][1] - routeCoords[i - 1][1]) * ratio;
                    return [lat, lng];
                }
            }
            return routeCoords[routeCoords.length - 1];
        }

        function step() {
            if (progress > totalDistance) {
                progress = 0; // Restart loop
            }

            const position = interpolatePosition(progress);
            marker.setLatLng(position);

            // Update timeline progress bar
            const progressPercent = (progress / totalDistance) * 100;
            document.getElementById('timeline-progress').style.width = progressPercent + '%';

            // Calculate current date
            const elapsed = (progress / totalDistance) * totalTime;
            const currentDate = new Date(startDate.getTime() + elapsed);

            // Format date as YYYY-MM-DD
            const formattedDate = currentDate.toISOString().split('T')[0];

            // Update timeline label
            document.getElementById('timeline-label').innerText = formattedDate;

            progress += stepSize;
            setTimeout(step, animationSpeed);
        }

        step();
    }
    
</script>

</body>
</html>
