<!DOCTYPE html>
<html>
<head>
    <title>Story Ark Moving Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
     <link href="https://fonts.googleapis.com/css2?family=Trocchi&display=swap" rel="stylesheet">

    <style>
        body { margin:0; padding:0; }
        #map { width: 100%; height: 100vh; }
        .legend {
            background: #F5F5F5;
            text-align: center;
            padding: 10px;
            line-height: 1.5em;
            color: #333;
            border-radius: 8px;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
            position: absolute;
            z-index: 1000;
            font-size: 14px;
            width: 170px;
        }
        
        .legend h4 {
    text-align: center; 
    margin-bottom: 8px;
}
        .legend p {
    text-align: left;    
    margin: 4px 0;       
}
        .legend img {
            vertical-align: middle;
            width: 25px;
            height: 25px;
            margin-left: 5px;
        }
        h1 {
            text-align: center;
            white-space: pre-wrap;
            font-family: 'Trocchi', serif;
            letter-spacing: 0.03em;
            font-weight: 400;
            margin: 20px 0 4px 0;
            font-size: 30px;
        }
        
        footer {
        position: fixed;
        bottom: 0;
        width: 100%;
        text-align: center;
        padding: 6px; 
        color: #777;
        font-size: 12px; 
        background: #fff;
        z-index: 500;
    }
        
        #static-car {
    position: fixed;
    bottom: 90px;
    right: 20px;
    width: 200px;
    opacity: 0.9;
    z-index: 999;
}
        .date-label {
  font-size: 14px;
  font-weight: bold;
  color: #007bb8;
  background: rgba(255,255,255,0.8);
  padding: 2px 6px;
  border-radius: 4px;
  white-space: nowrap;
}
        #timeline {
  position: fixed;
  bottom: 0;
  width: 100%;
  height: 100px;
  background: rgba(255,255,255,0.9);
  border-top: 2px solid #ccc;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Trocchi', serif;
  z-index: 800;
}

.timeline-container {
  position: relative;
  width: 85%;
  height: 60px;
}

.timeline-bar {
  position: absolute;
  top: 50%;
  left: 0;
  width: 100%;
  height: 4px;
  background: #ccc;
  border-radius: 2px;
  transform: translateY(-50%);
}

.timeline-marker {
  position: absolute;
  top: calc(50% - 8px);
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: #007bb8;
  transition: left 0.05s linear;
}

.timeline-labels-top,
.timeline-labels-bottom {
  position: absolute;
  width: 100%;
  display: flex;
  justify-content: space-between;
  font-size: 13px;
  color: #333;
}

.timeline-labels-top {
  top: 0;
}

.timeline-labels-bottom {
  bottom: 0;
  color: #666;
}
        
        @media (max-width: 768px) {
    h1 {
        font-size: 20px;
    }

    .legend {
        font-size: 12px;
        padding: 6px;
    }

    .legend img {
        width: 16px;
        height: 16px;
        margin-left: 4px;
    }

    #static-car {
        width: 100px;
        bottom: 10px;
        right: 10px;
    }

    footer {
        font-size: 10px;
        padding: 4px;
        position: relative;
        z-index: 100;
    }
        
    </style>
</head>
<body>
    
<h1>THE STORY ARK JOURNEY</h1>
    
<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
    
    const initialZoom = window.innerWidth < 768 ? 5 : 6; // Mobile = zoomed out

    // Initialize map
    const map = L.map('map', {
    center: [-30.5595, 22.9375],
    zoom: 6,
    minZoom: 5,
    maxZoom: 10,
    maxBounds: [
        [-37, 10],
        [-20, 35]
    ],
    maxBoundsViscosity: 0.8,
    zoomControl: false // turn off default
});

// Add custom zoom control on top right
L.control.zoom({
    position: 'topright' // move buttons
}).addTo(map);
    
    // Base map
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap & CartoDB',
        maxZoom: 19
    }).addTo(map);
    
    // circle marker
    const marker = L.circleMarker([0, 0], {
    radius: 8,
    color: '#007bb8',
    fillColor: '#007bb8',
    fillOpacity: 1,
    opacity: 1
}).addTo(map);
marker.setStyle({opacity: 0});
    
    // Use OpenRouteService API to generate road-snapped route
const apiKey = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjM1NmNkYWJlYmVjMDRiNzU5NzIwMjNiYTAxZmZkMTM5IiwiaCI6Im11cm11cjY0In0="; 

  //Route coordinates
    const coordinates = [
   [18.349998, -34.03333],
[19.161850, -32.179535],
[18.761217, -31.602021],
[17.461603, -29.223664],
[16.686399, -28.477564],
[16.795256, -28.431223],
[16.686399, -28.477564],
[16.795256, -28.431223],
[16.686399, -28.477564],
[16.795256, -28.431223],
[16.992807, -28.449563],
[16.872967, -29.248082],
[17.459885, -29.223238],
[17.255891, -28.826061],
[17.461603, -29.223664],
[19.121273, -31.375852],
[18.995583, -32.589442],
[19.240376, -32.768078],
[19.316716, -33.370650],
[19.121616, -31.378930],
[19.121616, -31.378930],
[18.904297, -32.191707],
[19.160992, -32.179245],
[18.904297, -32.191707],
[18.344407, -34.042428],
[21.717070, -34.136678],
[24.560429, -32.264106],
[27.580207, -30.969788],
[27.346464, -30.726940],
[28.362884, -31.069094],
[28.507239, -30.693476],
[27.212492, -30.713391],
[27.625553, -30.396194],
[27.600738, -29.834139],
[28.049644, -29.842547],
[28.507329, -29.336696],
[28.727215, -28.820461],
[28.423295, -28.508730],
[28.894324, -28.681384],
[30.298712, -29.046574],
[30.231317, -29.508021],
[28.811371, -30.346384],
[30.231317, -29.508021],
[31.023358, -29.848188],
[32.374727, -28.384668],
[32.278165, -28.023921],
[32.374727, -28.384668],
[31.960267, -28.222068],
[32.113818, -28.001138],
[32.278251, -28.023694],
[32.673139, -27.554230],
[32.278165, -28.023997],
[32.016010, -27.610293],
[32.241230, -26.983030],
[32.554137, -27.083288],
[32.555073, -27.084545],
[32.274560, -28.022898],
[31.017903, -29.852395],
[30.233892, -29.517805],
[30.940842, -30.004725],
[30.231317, -29.508021],
[32.278251, -28.023694],
[32.673139, -27.554230],
[32.829112, -26.865665],
[32.857627, -26.891302],
[32.673139, -27.554230],
[32.150915, -27.645594],
[32.673139, -27.554230],
[30.832138, -27.768476],
[30.563480, -25.874569],
[27.772201, -26.008783],
[28.157879, -25.939629],
[27.772201, -26.008783],
[27.787009, -25.983909],
[27.771337, -25.929673],
[27.397333, -25.938877],
[27.735040, -26.013445],
[27.397333, -25.938877],
[28.030447, -26.192969],
[27.397333, -25.938877],
[31.594938, -24.997074],
[28.276896, -25.753121],
[30.540476, -25.856234],
];

function chunkArray(arr, size) {
  const result = [];
  for (let i = 0; i < arr.length; i += size) {
    result.push(arr.slice(i, i + size));
  }
  return result;
}

async function fetchRoutes() {
  const chunks = chunkArray(coordinates, 20); // keep below ORS 50 limit
  let allRouteCoords = [];

  // Fetch each route segment only once
  for (let i = 0; i < chunks.length; i++) {
    const segment = (i < chunks.length - 1)
      ? [...chunks[i], chunks[i + 1][0]]
      : chunks[i];

    try {
      const response = await fetch("https://api.openrouteservice.org/v2/directions/driving-car/geojson", {
        method: "POST",
        headers: {
          "Authorization": apiKey,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ coordinates: segment })
      });
      const data = await response.json();

      if (data.features && data.features[0]) {
        const coords = data.features[0].geometry.coordinates.map(c => [c[1], c[0]]);
        allRouteCoords = allRouteCoords.concat(coords);
      } else {
        console.error("ORS error on segment", i, data);
      }
    } catch (err) {
      console.error("Fetch error on segment", i, err);
    }
  }

  if (allRouteCoords.length > 0) {
    const routeLine = L.polyline(allRouteCoords, { color: "#007bb8", weight: 4 }).addTo(map);
    map.fitBounds(routeLine.getBounds());

    // Start synced animation between map and timeline
    animateMarker(allRouteCoords, map, signpoints);
  }
}

    function animateMarker(routeCoords, duration = 60000) { // duration in ms
  let progress = 0;
  const totalSteps = routeCoords.length;
  marker.setStyle({opacity: 1}); // make the circle visible

  function step() {
    const idx = Math.floor(progress);
    if (idx < totalSteps - 1) {
      marker.setLatLng(routeCoords[idx]);
      progress += (totalSteps / (duration / 50)); // adjust speed here
      requestAnimationFrame(step);
    } else {
      marker.setLatLng(routeCoords[totalSteps - 1]);
    }
  }
  step();
}
    const signpoints = [
  { lat: -34.03333, lng: 18.349998, mileage: 0, date: "Oct '24" },
  { lat: -32.589442, lng: 18.995583, mileage: 1240, date: "Nov '24" },
  { lat: -30.726940, lng: 27.346464, mileage: 3659, date: "Dec '24" },
  { lat: -31.069094, lng: 28.362884, mileage: 6364, date: "Feb '25" },
 { lat: -29.046574, lng: 30.298712, mileage: 9294, date: "March '25" },
{ lat: -30.346384, lng: 28.811371, mileage: 11969, date: "May '25" },
{ lat: -29.848188, lng: 31.023358, mileage: 13628, date: "June '25" },
 { lat: -27.554230, lng: 32.673139, mileage: 16749, date: "Sept '25" },
 { lat: -27.768476, lng: 30.832138, mileage: 17514, date: "Oct '25" },

];

function computeCumulativeDistances(coords, map) {
  const distances = [0];
  for (let i = 1; i < coords.length; i++) {
    const d = map.distance(coords[i - 1], coords[i]); // meters
    distances.push(distances[i - 1] + d);
  }
  return distances;
}

// --- Helper: compute the fraction (0â€“1) of each signpost along the route ---
function computeSignpointFractions(routeCoords, signpoints, map) {
  const routeDistances = computeCumulativeDistances(routeCoords, map);
  const totalDist = routeDistances[routeDistances.length - 1];

  return signpoints.map(sp => {
    // find the closest point on the route
    let minIndex = 0;
    let minDist = Infinity;
    routeCoords.forEach((c, i) => {
      const d = map.distance(c, [sp.lat, sp.lng]);
      if (d < minDist) {
        minDist = d;
        minIndex = i;
      }
    });
    const frac = routeDistances[minIndex] / totalDist;
    return { ...sp, fraction: frac };
  });
}

// --- Animate the map marker + timeline in sync ---
function animateMarker(routeCoords, map, signpoints) {
  const totalDuration = 60000; // ms (adjust for desired animation speed)
  const distances = computeCumulativeDistances(routeCoords, map);
  const totalDist = distances[distances.length - 1];
  const startTime = performance.now();

  const marker = L.circleMarker(routeCoords[0], {
    radius: 7,
    color: "#007bb8",
    fillColor: "#007bb8",
    fillOpacity: 1
  }).addTo(map);

  const syncedSignpoints = computeSignpointFractions(routeCoords, signpoints, map);

  function step(now) {
    const elapsed = now - startTime;
    const progress = Math.min(elapsed / totalDuration, 1);
    const targetDist = totalDist * progress;

    // Find which segment weâ€™re on
    let i = 0;
    while (i < distances.length - 1 && distances[i + 1] < targetDist) i++;

    const segFrac = (targetDist - distances[i]) / (distances[i + 1] - distances[i]);
    const lat = routeCoords[i][0] + (routeCoords[i + 1][0] - routeCoords[i][0]) * segFrac;
    const lng = routeCoords[i][1] + (routeCoords[i + 1][1] - routeCoords[i][1]) * segFrac;

    marker.setLatLng([lat, lng]);

    // Sync the timeline
    updateTimeline(progress, syncedSignpoints);

    if (progress < 1) {
  requestAnimationFrame(animate);
} else {
  startTime = null;
  requestAnimationFrame(animate);
}

  requestAnimationFrame(step);
}

// --- Update the timeline marker & label ---
function updateTimeline(progress, signpoints) {
  const bar = document.getElementById("timeline-bar");
  const marker = document.getElementById("timeline-marker");
  const label = document.getElementById("timeline-label");

  // move marker along the bar
  const percent = progress * 100;
  marker.style.left = `${percent}%`;

  // find nearest signpoint by progress
  const index = Math.floor(progress * (signpoints.length - 1));
  const point = signpoints[index];

  // update label with your chosen parameters
  label.textContent = `${point.date}  â€¢  ${point.mileage} km`;

  // optional: color bar up to progress
  bar.style.width = `${percent}%`;
}

    
     const logIcon = L.icon({
        iconUrl: 'log.png',  // Replace with your Captainâ€™s Log icon
        iconSize: [20, 20],
        iconAnchor: [20, 40],
        popupAnchor: [0, -40]
    });
    const diaryIcon = L.icon({
        iconUrl: 'diary.png', // Replace with your Story Ark Diaries icon
        iconSize: [20, 20],
        iconAnchor: [20, 40],
        popupAnchor: [0, -40]
    });

    // Add all clickable markers
    const storyMarkers = [
        { title: "Captainâ€™s Log: Six months in, slow as can be", link: "https://www.storyark.co.za/captains-log/Blog%20Post%20Title%20One-k44nk", coords: [-28.500546, 28.437972] },
        { title: "Captainâ€™s Log: Into the flames", link: "https://www.storyark.co.za/captains-log/into-the-flames", coords: [-32.178236, 19.160587] },
        { title: "Story Ark Diaries: Here we go", link: "https://youtu.be/5w8PaHTJVeE", coords: [-33.977020, 18.496226] },
        { title: "Story Ark Diaries: On being brave", link: "https://youtu.be/RDQRIrlcWN4", coords: [-31.376805, 19.133976] },
        { title: "Story Ark Diaries: Leaving the safe harbour", link: "https://youtu.be/nrjCleNi7qE", coords: [-33.927543, 18.587417] },
        { title: "Story Ark Diaries: Moment of Zen - quiver trees", link: "https://youtu.be/v4wafK3BE0s", coords: [-31.418914, 19.250895] },
        { title: "Story Ark Diaries: Moment of Zen - Cederberg", link: "https://youtu.be/COCIYdMPc7c", coords: [-32.748081, 19.294222] },
        { title: "Story Ark Diaries: Fender-bender", link: "https://maps.app.goo.gl/JmXTA1Wvt5f3S1256", coords: [-31.450744, 18.950759] },
        { title: "Story Ark Diaries: The origin story", link: "https://youtu.be/e6tazPDxp1U", coords: [-33.996137, 18.396024] },
        { title: "Story Ark Diaries: Desert reign - an experimental sound-story", link: "https://youtu.be/8ZTUM_jL9h8", coords: [-29.039515, 17.104591] },
        { title: "Story Ark Diaries: Bad-ass punk lily", link: "https://youtu.be/Fp9_L314eCA", coords: [-31.137101, 19.193513] },
        { title: "Story Ark Diaries: Tending the dead", link: "https://youtu.be/n53UjoHvOkw", coords: [-31.185947, 27.489078] },
        { title: "Story Ark Diaries: The dog ate my homework", link: "https://youtu.be/UqIxgy2jnmk", coords: [-34.136575, 21.717111] },
        { title: "Story Ark Diaries: Moment of Zen - calm", link: "https://youtu.be/i15Egb1V9NU", coords: [-31.185947, 27.489078] },
        { title: "Story Ark Diaries: Time is running out", link: "https://youtu.be/m_T9mg5_v-Q", coords: [-31.205501, 30.043255] },
        { title: "Story Ark Diaries: Salt of the Earth", link: "https://youtu.be/SYxobUbZVbM", coords: [-30.635641, 27.501025] },
        { title: "Story Ark Diaries: Donâ€™t panic, stay calm", link: "https://youtu.be/8AgjANVk75g", coords: [-30.726151, 27.822664] },
        { title: "Story Ark Diaries: Childless cat lady", link: "https://youtu.be/n99GX3iNztk", coords: [-30.717890, 27.458709] },
        { title: "Story Ark Diaries: Water shepherds", link: "https://youtu.be/064g1Hu4Uoo", coords: [-28.816380, 28.719290] },
        { title: "Story Ark Diaries: Lesotho, by any other name", link: "https://youtu.be/ZEqCVtwGM9g", coords: [-29.363245, 28.351715] },
        { title: "Story Ark Diaries: Waiting for the Barbarians", link: "https://youtu.be/TVSLZlKVjw4", coords: [-13.132975, 39.623579] },
        { title: "Story Ark Diaries: Berg life", link: "https://youtu.be/umUtSZKzh80", coords: [-29.376895, 29.549334] },
        { title: "Story Ark Diaries: These boots", link: "https://youtu.be/zWFeBr8EIlE", coords: [-28.919069, 17.070351] },
        { title: "Story Ark Diaries: Dropping anchor", link: "https://youtu.be/zWFeBr8EIlE", coords: [-28.082242, 32.291739] },
        { title: "Story Ark Diaries: Chief navigator Mouse keeping her mitts in shape", link: "https://youtube.com/shorts/bIlQsJlewjQ?feature=share", coords: [-31.059140, 28.360576] },
        { title: "Story Ark Diaries: Maloti Mouse", link: "https://youtube.com/shorts/BnWvv4ZFReE?feature=share", coords: [-28.816380, 28.719290] },
        { title: "Story Ark Diaries: Karnmelk River", link: "https://youtube.com/shorts/_tpPrD9pYkk?feature=share", coords: [-30.799125, 27.272007] },
        { title: "Story Ark Diaries: Flying high", link: "https://youtube.com/shorts/1cgt2rETiB0?feature=share", coords: [-28.502370, 28.622331] },
        { title: "Story Ark Diaries: Searching for vultures, finding crows", link: "https://youtube.com/shorts/0D1QfpyvP9I?feature=share", coords: [-28.514066, 28.653881] },
        { title: "Story Ark Diaries: Going feral", link: "https://youtube.com/shorts/JYzWX_ViMi4?feature=share", coords: [-28.820691, 28.727339] },
        { title: "Captainâ€™s Log: Plastic poisoning: the new â€˜passive smokingâ€™, and weâ€™re all in it together", link: "https://www.storyark.co.za/captains-log/into-the-flames-5d2jt", coords: [-30.423295, 28.714374] },
        { title: "Captain's Log: The Devilâ€™s breath", link: "https://www.storyark.co.za/captains-log/into-the-flames-5d2jt-4y3nw", coords: [-29.932548, 31.001118] }
    ];

    function getYouTubeThumbnail(url) {
    const videoId = url.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|shorts\/))([\w-]+)/);
    return videoId ? `https://img.youtube.com/vi/${videoId[1]}/hqdefault.jpg` : '';
}
    
    storyMarkers.forEach(entry => {
    const icon = entry.title.includes("Captainâ€™s Log") ? logIcon : diaryIcon;

    const isYouTube = entry.link.includes("youtu");
    const thumbnail = isYouTube ? `<img src="${getYouTubeThumbnail(entry.link)}" width="200"><br/>` : "";

    const popupContent = `
        <a href="${entry.link}" target="_blank">
            <strong>${entry.title}</strong><br/>
            ${thumbnail}
        </a>
    `;

    L.marker(entry.coords, { icon: icon }).addTo(map)
        .bindPopup(popupContent);
});
      
    // legend
    const legend = L.control({ position: "topleft" });
legend.onAdd = function(map) {
    const div = L.DomUtil.create("div", "legend");
    div.innerHTML = `
        <h4>Ports of Call</h4>
        <p><img src="log.png"> Captainâ€™s Log</p>
        <p><img src="diary.png"> Story Ark Diaries</p>
    `;
    return div;
};
legend.addTo(map);
    
    fetchRoutes();
    
</script>
    
  <div id="timeline">
  <div class="timeline-container">
    <div class="timeline-labels-top">
      <span>Oct 2024</span>
      <span>Dec 2024</span>
      <span>Feb 2025</span>
      <span>Apr 2025</span>
      <span>Jun 2025</span>
      <span>Aug 2025</span>
      <span>Oct 2025</span>
    </div>
    <div class="timeline-bar"></div>
    <div id="timeline-marker" class="timeline-marker"></div>
    <div class="timeline-labels-bottom">
      <span>0 km</span>
      <span>400 km</span>
      <span>800 km</span>
      <span>1 200 km</span>
      <span>1 600 km</span>
      <span>2 000 km</span>
      <span>2 400 km</span>
    </div>
  </div>
</div>
    
<footer>
        By <a href="https://www.linkedin.com/in/skylathornton/" target="_blank">Skyla Thornton</a>,
        <a href="https://climate.sun.ac.za/" target="_blank">School for Climate Studies, Stellenbosch University</a>.
    </footer>
    <img id="static-car" src="storyark_car.png" alt="Car" />
</body>
</html>
